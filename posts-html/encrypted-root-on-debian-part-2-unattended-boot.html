---
author: admin
categories:
- Technical
date: 2021-06-11 17:50:31-07:00
markup: html
source: wordpress
tags:
- debian
- linux
- system administration
title: 'Encrypted root on debian part 2: unattended boot'
updated: 2021-06-11 18:12:38-07:00
wordpress_id: 630
wordpress_slug: encrypted-root-on-debian-part-2-unattended-boot
---
<!-- blogpost -->
<div class="entry-content">
<p>I want my debian boot to work as follows:</p>
<ol><li>If it’s in my house, it can boot without my being there. To make that happen, I’ll put the root disk key on a USB stick, which I keep in the computer.</li><li>If it’s not in my house, it needs a password to boot. This is the normal boot process.</li></ol>
<p>As in part 1, this guide is <strong>debian-specific</strong>. To learn more about the Linux boot process, see <a href="https://blog.za3k.com/migrating-an-existing-debian-installation-to-encrypted-root/">part 1.</a></p>
<p>First, we need to prepare the USB stick. Use ‘dmesg’ and/or ‘lsblk’ to make a note of the USB stick’s path (/dev/sdae for me). I chose to write to a filesystem rather than a raw block device.</p>
<pre class="wp-block-code"><code>sudo mkfs.ext4 /dev/sdae # Make a filesystem directly on the device. No partition table.
sudo blkid /dev/sdae # Make a note of the filesystem UUID for later</code></pre>
<p>Next, we’ll generate a key.</p>
<pre class="wp-block-code"><code>sudo mount /dev/sdae /mnt
sudo dd if=/dev/urandom of=/mnt/root-disk.key bs=1000 count=8</code></pre>
<p>Add the key to your root so it can actually decrypt things. You’ll be prompted for your password:</p>
<pre class="wp-block-code"><code>sudo cryptsetup luksAddKey ROOT_DISK_DEVICE /mnt/root-disk.key</code></pre>
<p>Make a script at /usr/local/sbin/unlockusbkey.sh</p>
<pre class="wp-block-code"><code>#!/bin/sh
USB_DEVICE=/dev/disk/by-uuid/a4b190b8-39d0-43cd-b3c9-7f13d807da48 # copy from blkid's output UUID=XXXX

if [ -b $USB_DEVICE ]; then
  # if device exists then output the keyfile from the usb key
  mkdir -p /usb
  mount $USB_DEVICE -t ext4 -o ro /usb
  cat /usb/root-disk.key
  umount /usb
  rmdir /usb
  echo "Loaded decryption key from USB key." &gt;&amp;2
else
  echo "FAILED to get USB key file ..." &gt;&amp;2
  /lib/cryptsetup/askpass "Enter passphrase"
fi</code></pre>
<p>Mark the script as executable, and optionally test it.</p>
<pre class="wp-block-code"><code>chmod +x /usr/local/sbin/unlockusbkey.sh
sudo /usr/local/sbin/unlockusbkey.sh | cmp /mnt/root-disk.key</code></pre>
<p>Edit /etc/crypttab to add the script.</p>
<pre class="wp-block-code"><code>root PARTLABEL=root_cipher none luks,keyscript=/usr/local/sbin/unlockusbkey.sh</code></pre>
<p>Finally, re-generate your initramfs. I recommend either having a live USB or keeping a backup initramfs.</p>
<pre class="wp-block-code"><code>sudo update-initramfs -u</code></pre>
<p>[1] This post is loosely based on a chain of tutorials based on each other, including <a href="https://www.oxygenimpaired.com/ubuntu-with-grub2-luks-encrypted-lvm-root-hidden-usb-keyfile">this</a><br/>[2] However, those collectively looked both out of date and like they were written without true understanding, and I wanted to clean up the mess. More definitive information was sourced from the actual <a href="https://cryptsetup-team.pages.debian.net/cryptsetup/README.initramfs.html">cryptsetup</a> documentation.</p>
</div>

<!-- comments -->
